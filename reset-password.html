<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <title>Redefinir Senha - Tindecisos</title>
    <script src="js/firebase-config.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, verifyPasswordResetCode, confirmPasswordReset } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        document.addEventListener('DOMContentLoaded', () => {
            // Inicializa o Firebase nesta página antes de usar qualquer serviço
            if (typeof firebaseConfig !== 'undefined') {
                initializeApp(firebaseConfig);
            }

            const auth = getAuth();
            const messageElement = document.getElementById('message');
            const formElement = document.getElementById('reset-form');
            const passwordInput = document.getElementById('new-password');
            const submitButton = document.getElementById('submit-btn');

            const urlParams = new URLSearchParams(window.location.search);
            const actionCode = urlParams.get('oobCode');

            if (!actionCode) {
                messageElement.textContent = "Código de redefinição inválido ou ausente. Por favor, solicite um novo link.";
                formElement.style.display = 'none';
                return;
            }

            // 1. Verificar o código
            verifyPasswordResetCode(auth, actionCode)
                .then((email) => {
                    messageElement.textContent = `Redefinindo a senha para: ${email}`;
                    formElement.style.display = 'flex'; // Mostra o formulário
                })
                .catch((error) => {
                    console.error("Erro ao verificar código:", error);
                    messageElement.textContent = "O link é inválido ou já foi usado. Por favor, solicite um novo.";
                    formElement.style.display = 'none';
                });

            // 2. Lidar com o envio do formulário
            formElement.addEventListener('submit', (e) => {
                e.preventDefault();
                const newPassword = passwordInput.value;
                if (newPassword.length < 6) {
                    messageElement.textContent = "A senha deve ter pelo menos 6 caracteres.";
                    return;
                }

                submitButton.disabled = true;
                submitButton.textContent = "Salvando...";

                // 3. Confirmar a nova senha
                confirmPasswordReset(auth, actionCode, newPassword)
                    .then(() => {
                        messageElement.textContent = "Senha redefinida com sucesso! Você já pode fechar esta página e fazer login com sua nova senha.";
                        formElement.style.display = 'none';
                    })
                    .catch((error) => {
                        console.error("Erro ao redefinir senha:", error);
                        messageElement.textContent = "Ocorreu um erro ao salvar sua nova senha. Tente novamente.";
                        submitButton.disabled = false;
                        submitButton.textContent = "Salvar Nova Senha";
                    });
            });
        });
    </script>
</head>
<body style="font-family: Inter, sans-serif;">
    <div class="app-container">
        <div class="screen active" style="justify-content: center; text-align: center; gap: 1.5rem;">
            <h1>Redefinir Senha</h1>
            <p id="message">Verificando seu link...</p>
            <form id="reset-form" style="display: none; flex-direction: column; gap: 1rem; width: 100%;">
                <input type="password" id="new-password" placeholder="Digite sua nova senha" required>
                <button type="submit" id="submit-btn" class="start-btn">Salvar Nova Senha</button>
            </form>
        </div>
    </div>
</body>
</html>